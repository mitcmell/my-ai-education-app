<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Education Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Typing animation */
        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .typing-dots span {
            height: 6px;
            width: 6px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 80%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            40% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Message animations */
        .message-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom button hover effects */
        .send-button {
            transition: all 0.2s ease;
        }
        .send-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="bg-white">
    <!-- Header -->
    <header class="border-b border-gray-200 bg-white sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-orange-400 to-red-500 rounded-lg flex items-center justify-center">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">AI Education Assistant</h1>
                        <p class="text-sm text-gray-500">Powered by Amazon Bedrock</p>
                    </div>
                </div>
                
                <!-- Settings dropdown -->
                <div class="relative">
                    <button onclick="toggleSettings()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                    
                    <!-- Settings panel -->
                    <div id="settingsPanel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg border border-gray-200 p-4 z-20">
                        <h3 class="font-semibold text-gray-900 mb-4">Assistant Settings</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Learning Mode</label>
                                <select id="mode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="standard">Standard - Direct answers</option>
                                    <option value="socratic">Socratic - Guided questions</option>
                                    <option value="step-by-step">Step-by-Step - Detailed breakdown</option>
                                    <option value="creative">Creative - Fun analogies</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subject Focus</label>
                                <select id="subject" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="general">General</option>
                                    <option value="math">Mathematics</option>
                                    <option value="science">Science</option>
                                    <option value="history">History</option>
                                    <option value="literature">Literature</option>
                                    <option value="coding">Programming</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Response Length</label>
                                <select id="responseLength" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="concise">Concise</option>
                                    <option value="balanced" selected>Balanced</option>
                                    <option value="detailed">Detailed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button onclick="clearChat()" class="w-full text-left p-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                Clear conversation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main chat container -->
    <div class="max-w-4xl mx-auto h-screen flex flex-col">
        <!-- Chat messages area -->
        <div id="chatContainer" class="flex-1 overflow-y-auto custom-scrollbar px-4 py-6">
            <div id="chat" class="space-y-6">
                <!-- Welcome message -->
                <div class="flex justify-start">
                    <div class="max-w-3xl">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                    <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                    <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="bg-gray-50 rounded-2xl px-4 py-3 message-fade-in">
                                <p class="text-gray-800">Hello! I'm your AI education assistant. I can help you learn and understand various topics. Feel free to ask me anything, and I'll adapt my teaching style based on your preferences.</p>
                                <p class="text-gray-600 text-sm mt-2">ðŸ’¡ Try different learning modes in the settings to see how my responses change!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input area -->
        <div class="border-t border-gray-200 bg-white px-4 py-4">
            <div class="max-w-4xl mx-auto">
                <div class="relative">
                    <textarea 
                        id="message" 
                        placeholder="Ask me anything..."
                        class="w-full p-4 pr-12 border border-gray-300 rounded-xl resize-none focus:ring-2 focus:ring-orange-500 focus:border-transparent min-h-[52px] max-h-32"
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    
                    <button 
                        id="sendButton"
                        onclick="sendMessage()"
                        disabled
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-gray-300 text-white rounded-lg send-button disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                    >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                
                <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                    <span>Press Shift+Enter for new line</span>
                    <span id="charCount">0 characters</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoading = false;

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
            
            // Update character count
            const charCount = textarea.value.length;
            document.getElementById('charCount').textContent = `${charCount} characters`;
            
            // Enable/disable send button
            const sendButton = document.getElementById('sendButton');
            if (textarea.value.trim() && !isLoading) {
                sendButton.disabled = false;
                sendButton.classList.remove('bg-gray-300');
                sendButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
            } else {
                sendButton.disabled = true;
                sendButton.classList.add('bg-gray-300');
                sendButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            }
        }

        // Handle keyboard shortcuts
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (!isLoading && event.target.value.trim()) {
                    sendMessage();
                }
            }
        }

        // Toggle settings panel
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        // Clear chat
        function clearChat() {
            const chat = document.getElementById('chat');
            chat.innerHTML = `
                <div class="flex justify-start">
                    <div class="max-w-3xl">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                    <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                    <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="bg-gray-50 rounded-2xl px-4 py-3 message-fade-in">
                                <p class="text-gray-800">Hello! I'm your AI education assistant. I can help you learn and understand various topics. Feel free to ask me anything, and I'll adapt my teaching style based on your preferences.</p>
                                <p class="text-gray-600 text-sm mt-2">ðŸ’¡ Try different learning modes in the settings to see how my responses change!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            toggleSettings();
        }

        // Close settings when clicking outside
        document.addEventListener('click', function(event) {
            const settingsPanel = document.getElementById('settingsPanel');
            const settingsButton = event.target.closest('[onclick="toggleSettings()"]');
            
            if (!settingsPanel.contains(event.target) && !settingsButton) {
                settingsPanel.classList.add('hidden');
            }
        });

        // Focus on input when page loads
        window.addEventListener('load', function() {
            document.getElementById('message').focus();
        });

        // Initialize input handlers
        const messageInput = document.getElementById('message');
        messageInput.addEventListener('input', function() {
            autoResize(this);
        });

        async function sendMessage() {
            const messageInput = document.getElementById('message');
            const chat = document.getElementById('chat');
            const chatContainer = document.getElementById('chatContainer');
            
            const message = messageInput.value.trim();
            if (!message || isLoading) return;

            isLoading = true;
            
            // Get settings
            const mode = document.getElementById('mode').value;
            const subject = document.getElementById('subject').value;
            const responseLength = document.getElementById('responseLength').value;

            // Add user message
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex justify-end message-fade-in';
            userMessageDiv.innerHTML = `
                <div class="max-w-3xl">
                    <div class="bg-orange-500 text-white rounded-2xl px-4 py-3">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            chat.appendChild(userMessageDiv);

            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            document.getElementById('charCount').textContent = '0 characters';
            autoResize(messageInput);

            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex justify-start message-fade-in';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="max-w-3xl">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="bg-gray-50 rounded-2xl px-4 py-3">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            chat.appendChild(typingDiv);

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                console.log('Sending request:', { message, mode, subject, responseLength });
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        mode: mode,
                        subject: subject,
                        responseLength: responseLength
                    })
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // Handle different response formats
                let aiResponse = '';
                if (data.response) {
                    aiResponse = data.response;
                } else if (data.text) {
                    aiResponse = data.text;
                } else if (data.content) {
                    aiResponse = data.content;
                } else {
                    console.log('Unexpected response format:', data);
                    aiResponse = 'I received a response but in an unexpected format. Please check the console for details.';
                }
                
                // Add AI response
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'flex justify-start message-fade-in';
                aiMessageDiv.innerHTML = `
                    <div class="max-w-3xl">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                    <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                    <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="bg-gray-50 rounded-2xl px-4 py-3">
                                <div class="text-gray-800 whitespace-pre-wrap">${aiResponse.replace(/\n/g, '<br>')}</div>
                            </div>
                        </div>
                    </div>
                `;
                chat.appendChild(aiMessageDiv);
                
            } catch (error) {
                console.error('Error details:', error);
                
                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex justify-start message-fade-in';
                errorDiv.innerHTML = `
                    <div class="max-w-3xl">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke="white" stroke-width="2"/>
                                </svg>
                            </div>
                            <div class="bg-red-50 border border-red-200 rounded-2xl px-4 py-3">
                                <div class="text-red-800">
                                    <strong>Error:</strong> ${error.message}<br>
                                    <span class="text-sm text-red-600">Please try again or check the browser console for more details.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                chat.appendChild(errorDiv);
            } finally {
                isLoading = false;
                autoResize(messageInput);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                messageInput.focus();
            }
        }
    </script>
</body>
</html>
